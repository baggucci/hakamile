<div class="container mt-5">
  
  <%# --- フラッシュメッセージ --- %>
  <% if flash.now[:alert] %>
    <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
      <%= flash.now[:alert] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <% if flash[:notice] %>
    <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
      <%= flash[:notice] %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% end %>

  <%# --- ヘッダーセクション --- %>
  <section class="posts-header mb-5">
    <div class="row align-items-center">
      <div class="col-lg-8">
        <h1 class="display-5 font-serif fw-bold text-primary-custom mb-3">
          <i class="fas fa-pen-alt me-3 text-gold"></i>墓参り記録
        </h1>
        <p class="lead text-muted">
          みんなの心に残る墓参り体験を共有しています
          <% if @posts.present? %>
            <span class="posts-count">（<%= @posts.total_count %>件の投稿）</span>
          <% end %>
        </p>
      </div>
      <div class="col-lg-4 text-end">
        <%= link_to new_post_path, class: "btn btn-gold btn-lg" do %>
          <i class="fas fa-plus me-2"></i>投稿する
        <% end %>
      </div>
    </div>
  </section>

  <%# --- 投稿一覧 --- %>
  <section class="posts-grid">
    <% if @posts.present? %>
      <div class="row g-4">
        <% @posts.each do |post| %>
          <div class="col-lg-6">

            <%# --- カードデザイン開始 --- %>
            <div class="card border-0 shadow h-100">
            <%# 0. 写真（3枚まで）を冒頭に追加  %>
              <% if post.images.attached? %>
                <div class="row g-1 px-2 pt-2">
                  <%# 3枚だけ取り出して表示 %>
                  <% post.images.first(3).each do |image| %>
                    <div class="col-4">
                      <%= link_to post do %>
                        <%# variantを使ってリサイズ（処理が重い場合は variant ではなく直接表示に変えてください） %>
                        <% if image.variable? %>
                          <%= image_tag image.variant(resize_to_fill: [200, 200]), class: 'img-fluid rounded', style: "width: 100%; aspect-ratio: 1/1; object-fit: cover;" %>
                        <% else %>
                          <%= image_tag image, class: 'img-fluid rounded', style: "width: 100%; aspect-ratio: 1/1; object-fit: cover;" %>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
              
              <div class="card-body">
                
                <%# 1. 墓所名 %>
                <p class="text-muted small mb-1">
                  <i class="fas fa-monument me-1"></i>
                  <%= link_to "#{post.grave&.name || '不明な場所'}のお墓", post, class: 'text-muted text-decoration-none' %>
                </p>

                <%# 2. Postのタイトル（＋非公開マーク） %>
                <h5 class="fw-bold">
                  <%= link_to post.title, post, class: 'text-dark text-decoration-none' %>

                  <% if post.unpublished? %>
                    <span class="badge bg-secondary ms-2" style="font-size: 0.6em; vertical-align: middle;">
                      <i class="fas fa-lock me-1"></i>非公開
                    </span>
                  <% end %>
                </h5>
                
                <%# 3. 投稿本文（60字で省略） %>
                <p class="card-text mt-2">
                  <%= truncate(post.body, length: 60) %>
                  <% if post.body.length > 60 %>
                    <%= link_to 'もっとみる', post, class: 'text-muted small' %>
                  <% end %>
                </p>

                <%# 4. ユーザー名と日付 %>
                <div class="d-flex align-items-center mt-3 border-top pt-3">
                  <i class="fas fa-user-circle fa-2x text-muted me-2"></i>
                  <span class="text-muted small"><%= post.user&.name || 'ユーザー' %></span>
                  
                  <span class="ms-auto text-muted small">
                    <%= time_ago_in_words(post.created_at) %>前
                  </span>
                </div>

                <%# 5. エンゲージメント情報（いいね・コメント数） %>
                <div class="engagement-info mt-2">
                  <div class="d-flex align-items-center gap-3 small text-muted">
                    <span class="engagement-item">
                      <i class="fas fa-heart me-1"></i>
                      <%= post.respond_to?(:likes_count) ? (post.likes_count || 0) : 0 %>
                    </span>
                    <span class="engagement-item">
                      <i class="fas fa-comment me-1"></i>
                      <%= post.respond_to?(:comments_count) ? (post.comments_count || 0) : 0 %>
                    </span>
                    <span class="read-more text-gold ms-auto">
                      <%= link_to post, class: "text-decoration-none text-gold" do %>
                        <i class="fas fa-chevron-right"></i>
                      <% end %>
                    </span>
                  </div>
                </div>

              </div> 
            </div> 
            <%# --- カードデザイン終了 --- %>

          </div> 
        <% end %>
      </div>

      <%# --- ページネーション --- %>
      <div class="mt-5 d-flex justify-content-center">
        <%= paginate @posts %>
      </div>

    <% else %>
      <%# --- 空の状態（投稿がない場合） --- %>
      <div class="empty-state text-center py-5">
        <div class="empty-icon mb-4">
          <i class="fas fa-pen-nib fa-5x text-muted"></i>
        </div>
        <h3 class="text-muted mb-3">まだ投稿がありません</h3>
        <p class="text-muted mb-4">
          あなたの墓参り体験を最初に投稿してみませんか？<br>
          きっと同じ想いを持つ人たちと繋がることができるでしょう。
        </p>
        <%= link_to new_post_path, class: "btn btn-gold btn-lg" do %>
          <i class="fas fa-plus me-2"></i>最初の投稿をする
        <% end %>
      </div>
    <% end %>

  </section>
</div>