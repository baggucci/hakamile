<div class="container">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <%# 1. トップページへのリンク %>
      <li class="breadcrumb-item">
        <%= link_to "トップ", root_path %>
      </li>

      <%# 2. 偉人一覧ページへのリンク %>
      <li class="breadcrumb-item">
        <%= link_to "偉人一覧", graves_path %>
      </li>

      <%# 3. この投稿が属する墓所（偉人）ページへのリンク %>
      <li class="breadcrumb-item">
        <%= link_to @post.grave.name, grave_path(@post.grave) %>
      </li>

      <%# 4. 現在のページ（投稿者の名前 + "さんの投稿"） %>
      <li class="breadcrumb-item active" aria-current="page">
        <%= @post.user&.name || '退会したユーザー' %>さんの投稿
      </li>
    </ol>
  </nav>

  <h3 class="my-4"><%= @post.title %></h3>

  <div class="card">
    <div class="card-body">
      <p><strong>投稿者:</strong> <%= link_to @post.user.name, @post.user %></p>
      <p><strong>墓所:</strong> <%= @post.grave.name %></p>
      <p><strong>投稿日時:</strong> <%= l @post.created_at, format: :long %></p>
      <hr>
      <p><%= simple_format(@post.body) %></p>

      <%# --- 画像表示エリア --- %>
      <%# 画像が添付されているかを確認 %>
      <% if @post.images.attached? %>
        <div class="post-images">
          <%# 添付されている画像を1枚ずつ取り出して表示 %>
          <% @post.images.each do |image| %>
            <%# image_tagで画像を表示。variantでサイズを調整するのがおすすめ %>
            <%= image_tag image.variant(resize_to_limit: [500, 500]) %>
          <% end %>
        </div>
      <% end %>

      <%# --- ここからいいねボタンを追加 --- %>
      <div class="like-section my-3" id="like-button-<%= @post.id %>">
        <% if @post.user != current_user %>
          <%= render 'likes/like_button', post: @post %>
        <% end %>
      </div>
      <%# --- ここまで --- %>

    </div>
    
    <%# 投稿者本人である場合のみ編集・削除ボタンを表示 %>
    <% if @post.user == current_user %>
      <div class="card-footer">
        <%= link_to "編集する", edit_post_path(@post), class: "btn btn-success" %>
        <%= link_to "削除する", post_path(@post), method: :delete, data: { "turbo-method": :delete, "turbo-confirm": "本当に削除しますか？" }, class: "btn btn-danger" %>
      </div>
    <% end %>


    <%# --- ここからコメント機能を追加 --- %>
  <div class="comment-section mt-4">
    <hr>
    <h4 class="mb-3">コメント</h4>

    <%# --- コメント一覧 --- %>
    <div class="comment-list mb-4" id="comment-list-<%= @post.id %>">
      <% @post.comments.each do |comment| %>
        <div class="card mb-2">
          <div class="card-body py-2">
            <strong><%= comment.user.name %></strong>
            <small class="text-muted ms-2"><%= l comment.created_at, format: :short %></small>
            <p class="card-text mt-1 mb-1"><%= simple_format(h(comment.body), {}, wrapper_tag: "span") %></p>
          </div>
          <% if comment.user == current_user %>
            <div class="card-footer py-1 text-end">
              <%= link_to '削除', post_comment_path(@post, comment), method: :delete, data: { "turbo-method": :delete, "turbo-confirm": '本当に削除しますか？' }, class: 'btn btn-sm btn-outline-danger' %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# --- コメント投稿フォーム --- %>
    <% if user_signed_in? %>
      <%= form_with model: [@post, @comment] do |f| %>
        <div class="mb-3">
          <%= f.text_area :body, rows: 3, class: 'form-control', placeholder: 'コメントを追加...' %>
        </div>
        <%= f.submit "コメントを投稿", class: 'btn btn-primary' %>
      <% end %>
    <% else %>
      <p>コメントを投稿するには<a href="<%= new_user_session_path %>">ログイン</a>してください。</p>
    <% end %>
  </div>
  <%# --- ここまで --- %>
  
  </div>
</div>