<h1><%= @grave.name %> の詳細</h1>

<p><strong>人名:</strong> <%= @grave.name %></p>
<p><strong>所在地都道府県:</strong> <%= @grave.prefecture %></p>
<p><strong>住所:</strong> <%= @grave.address %></p>
<p><strong>説明文:</strong> <%= @grave.description %></p>

<p>
  <strong>ジャンル:</strong>
  <% if @grave.genres.present? %>
    <%# pluck(:name)でジャンル名だけの配列を取得し、" / "で連結 %>
    <%= @grave.genres.pluck(:name).join(' / ') %>
  <% else %>
    ジャンル未登録
  <% end %>
</p>

<hr>

<h3>位置情報</h3>
<p><strong>緯度:</strong> <%= @grave.latitude %></p>
<p><strong>経度:</strong> <%= @grave.longitude %></p>

<hr>

<h3>地図</h3>
<div id="map" style="height: 400px; width: 100%;" 
     data-latitude="<%= @grave.latitude %>" 
     data-longitude="<%= @grave.longitude %>"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&callback=initMap" async defer></script>

<hr>

<%# --- コメント機能 --- %>
<% @posts.each do |post| %>
  <div class="row mb-5"> <%# 投稿ごとに余白を追加 %>
    <div class="col-md-8 offset-md-2">
      <%# --- ここに投稿自体の内容を表示（例） --- %>
      <h4><%= post.title %></h4>
      <p><%= post.body %></p>
      <%# ------------------------------------ %>

      <h5 class="mb-3 mt-4">コメント</h5>

      <%# ログインしているユーザーのみフォームを表示 %>
      <% if user_signed_in? %>
        <%= form_with model: [post, Comment.new] do |f| %>
          <div class="form-group mb-3">
            <%= f.text_area :body, rows: 2, class: 'form-control', placeholder: 'この投稿にコメントする...' %>
          </div>
          <%= f.submit "コメント投稿", class: 'btn btn-outline-primary btn-sm' %>
        <% end %>
      <% else %>
        <p>
          コメントを投稿するには、
          <%= link_to "ログイン", new_user_session_path %>
          が必要です。
        </p>
      <% end %>

      <hr class="my-4">

      <%# コメント一覧表示 (修正点1) %>
      <div id="comments-area-post-<%= post.id %>"> <%# IDをユニークに %>
        <% if post.comments.any? %>
          <% post.comments.each do |comment| %>
            <div class="card mb-3">
              <div class="card-body">
                <p class="card-text"><%= simple_format(h(comment.body)) %></p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted">
                    投稿者: <%= comment.user.name %> |
                    <%= l comment.created_at, format: :long %>
                  </small>
                  <% if comment.user == current_user %>
                    <%# 削除リンク (修正点2) %>
                    <%= link_to "削除",
                                post_comment_path(post, comment),
                                method: :delete,
                                data: { confirm: "本当に削除しますか？" },
                                class: 'btn btn-outline-danger btn-sm' %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <p>この投稿にはまだコメントがありません。</p>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<%= link_to '一覧に戻る', graves_path %>
